<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Survey Timer (Same Tab)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; color:#111; margin:0; padding:0; }
    .wrap { max-width:720px; margin:40px auto; padding:0 16px; text-align:center; }
    input[type="url"], input[type="number"] { width:100%; padding:10px 12px; font-size:1rem; box-sizing:border-box; margin:6px 0 12px; }
    button { padding:10px 16px; font-size:1rem; cursor:pointer; border-radius:8px; border:1px solid #cbd5e1; background:#111827; color:#fff; font-weight:600; }
    .hint { opacity:.75; font-size:.9rem; margin-top:8px; }
    label { display:block; margin:10px 0; }
  </style>
</head>
<body>
  <div class="wrap" id="setup">
    <h1>Start timed survey</h1>
    <p>Paste your REDCap survey link and set minutes. The survey will open in <strong>this tab</strong>.</p>
    <input id="urlBox" type="url" placeholder="https://redcap.your.edu/surveys/?s=ABC123" />
    <label>Minutes: <input id="minsBox" type="number" min="1" step="1" value="15" /></label>
    <label><input id="helperChk" type="checkbox" /> Open a small helper window that shows the countdown while Iâ€™m in REDCap</label>
    <button id="startBtn">Start Survey</button>
    <p class="hint">Tip: prefill with <code>?u=...</code> and <code>&m=15</code>. Add <code>&helper=1</code> to auto-open the helper window.</p>
  </div>

  <script>
    function qs(name){ const m=location.search.match(new RegExp('[?&]'+name+'=([^&]+)')); return m?decodeURIComponent(m[1]):''; }
    function fmt(secs){ secs=Math.max(0,secs|0); const m=Math.floor(secs/60), s=secs%60; return m+':'+String(s).padStart(2,'0'); }

    const urlParam = qs('u');
    const minutesParam = parseInt(qs('m')||'15',10);
    const helperParam = qs('helper');
    let SURVEY_URL = '';
    let TOTAL_MINUTES = isNaN(minutesParam)?15:Math.max(1,minutesParam);
    let endMs = 0;

    const urlBox = document.getElementById('urlBox');
    const minsBox = document.getElementById('minsBox');
    const helperChk = document.getElementById('helperChk');
    const startBtn = document.getElementById('startBtn');

    // helper popup
    function openHelper(){
      const secsLeft = TOTAL_MINUTES*60;
      const html = `
<!doctype html><meta charset="utf-8"><title>Timer</title>
<style>body{margin:0;font-family:system-ui,Arial} 
.bar{padding:12px;text-align:center;font-weight:700;font-size:24px}
.warn{background:#fff3cd;color:#7a5a00}</style>
<div class="bar" id="bar"><span id="t">${fmt(secsLeft)}</span></div>
<script>
function fmt(s){s=Math.max(0,s|0);var m=Math.floor(s/60),x=s%60;return m+':'+String(x).padStart(2,'0')}
var end = Date.now() + ${secsLeft}*1000;
var t=document.getElementById('t'),bar=document.getElementById('bar');
var WARN=60;
function tick(){
  var rem=Math.ceil((end-Date.now())/1000);
  if(rem<=0){rem=0;clearInterval(h);bar.classList.add('warn');}
  else if(rem<=WARN){bar.classList.add('warn');}
  t.textContent=fmt(rem);
}
var h=setInterval(tick,250);tick();
<\/script>`;
      const w = window.open('', '', 'width=260,height=120');
      if (!w) return alert('Popup blocked. Please allow pop-ups.');
      w.document.open(); w.document.write(html); w.document.close();
    }

    function startSurvey(){
      TOTAL_MINUTES = Math.max(1, parseInt(minsBox.value||'15',10));
      if (helperChk.checked) openHelper();
      location.href = SURVEY_URL;
    }

    if (urlParam){
      urlBox.value = urlParam;
      minsBox.value = TOTAL_MINUTES;
      SURVEY_URL = urlParam;
      if (helperParam==='1') helperChk.checked = true;
    }

    startBtn.addEventListener('click', () => {
      if (!urlBox.value) return alert('Paste your REDCap survey link.');
      SURVEY_URL = urlBox.value.trim();
      startSurvey();
    });
  </script>
</body>
</html>

