<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Survey Timer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, Arial, sans-serif; text-align:center; padding:40px; max-width:680px; margin:0 auto; }
    label,input,button { font-size: 1rem; }
    #timer { font-size: 3rem; margin: 16px 0 24px; }
    #startBtn { padding: 10px 18px; cursor:pointer; }
    .warn { color: #b33; }
    .row { margin: 10px 0; }
    #urlBox { width: 100%; padding: 8px; }
  </style>
</head>
<body>
  <h1>Please complete the survey</h1>

  <div id="setup">
    <p class="row">Paste your REDCap survey link:</p>
    <input id="urlBox" type="url" placeholder="https://your-redcap.edu/surveys/?s=ABC123">
    <div class="row">
      <label>Minutes: <input id="minsBox" type="number" value="15" min="1" step="1"></label>
    </div>
    <button id="prepBtn">Load</button>
    <p style="font-size:.9rem;opacity:.8">Tip: you can prefill this page with <code>?u=...</code> and <code>&m=15</code>.</p>
  </div>

  <div id="run" style="display:none;">
    <p>You will have <strong id="mins">15</strong> minutes to finish.</p>
    <div id="timer">15:00</div>
    <button id="startBtn">Start Survey</button>
    <p>The survey will open in a new tab.</p>
  </div>

  <script>
    function qs(name){ const m=location.search.match(new RegExp('[?&]'+name+'=([^&]+)')); return m?decodeURIComponent(m[1]):''; }
    var SURVEY_URL = qs('u');
    var TOTAL_MINUTES = parseInt(qs('m')||'15',10);

    var setup = document.getElementById('setup');
    var run = document.getElementById('run');
    var urlBox = document.getElementById('urlBox');
    var minsBox = document.getElementById('minsBox');
    var timerEl = document.getElementById('timer');
    var minsEl = document.getElementById('mins');
    var prepBtn = document.getElementById('prepBtn');
    var startBtn = document.getElementById('startBtn');

    function fmt(s){ var m=Math.floor(s/60), ss=s%60; return m+':'+String(ss).padStart(2,'0'); }

    function ready(url, mins){
      SURVEY_URL = url; TOTAL_MINUTES = mins;
      setup.style.display = 'none';
      run.style.display = '';
      minsEl.textContent = TOTAL_MINUTES;
      timerEl.textContent = fmt(TOTAL_MINUTES*60);
    }

    prepBtn.addEventListener('click', function(){
      if (!urlBox.value) { alert('Paste your REDCap survey link.'); return; }
      ready(urlBox.value.trim(), Math.max(1, parseInt(minsBox.value||'15',10)));
    });

    if (SURVEY_URL) {
      urlBox.value = SURVEY_URL;
      if (!isNaN(TOTAL_MINUTES)) minsBox.value = TOTAL_MINUTES;
      ready(SURVEY_URL, TOTAL_MINUTES);
    }

    startBtn.addEventListener('click', function(){
      startBtn.disabled = true;
      var end = Date.now() + TOTAL_MINUTES*60*1000;
      var surveyWin = window.open(SURVEY_URL, '_blank');

      var tick = setInterval(function(){
        var remaining = Math.ceil((end - Date.now())/1000);
        if (remaining <= 0) {
          remaining = 0; clearInterval(tick);
          try { if (surveyWin && !surveyWin.closed) surveyWin.close(); } catch(e){}
          alert('Time is up â€” please return to the survey and submit.');
        }
        timerEl.textContent = fmt(remaining);
        if (remaining <= 60) timerEl.classList.add('warn');
      }, 250);
    });
  </script>
</body>
</html>

