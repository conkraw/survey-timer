<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pediatric Clerkship Practical Examination</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --maxw: 860px; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; color:#0f172a; background:#fff; }
    .wrap { max-width: var(--maxw); margin: 40px auto; padding: 0 20px; }
    h1 { font-size: 1.75rem; margin: 0 0 8px; }
    h2 { font-size: 1.15rem; margin: 24px 0 8px; }
    p  { line-height: 1.55; margin: 10px 0; }
    ul { margin: 8px 0 0 22px; }
    li { margin: 6px 0; }
    .muted { opacity:.8; }
    .btn { display:inline-block; margin-top: 20px; padding: 12px 18px; font-weight:700; border-radius: 10px;
           background:#111827; color:#fff; text-decoration:none; border:1px solid #111827; }
    .btn:focus { outline: 3px solid #60a5fa; outline-offset: 2px; }
    .panel { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:18px; }
    .fallback { display:none; margin-top:14px; }
    .fallback a { color:#0b57d0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Welcome to the Pediatric Clerkship Practical Examination!</h1>
    <div class="panel">
      <p>… exam instructions …</p>

      <a id="startBtn" class="btn" href="#">Start Survey</a>
      <p class="muted">You will have <strong>60 minutes</strong> to complete the examination once you start.</p>
      <div id="fallback" class="fallback">
        <p><strong>Pop-ups were blocked.</strong> Please allow pop-ups for this site and click Start again, or open the survey directly: <a id="directLink" href="#">Open survey</a></p>
      </div>
    </div>
  </div>

  <script>
    // --- Helpers ---
    function qs(name){ const m=location.search.match(new RegExp('[?&]'+name+'=([^&]+)')); return m?decodeURIComponent(m[1]):''; }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    const SURVEY_URL = qs('u');
    const TOTAL_MINUTES = 60;
    const startBtn = document.getElementById('startBtn');
    const fallback = document.getElementById('fallback');
    const directLink = document.getElementById('directLink');

    if (!SURVEY_URL) {
      startBtn.addEventListener('click', e=>{ e.preventDefault(); alert('Missing survey URL. Add ?u=... to this page link.'); });
    } else {
      directLink.href = SURVEY_URL;
      startBtn.addEventListener('click', e=>{
        e.preventDefault();
        launchSideBySide();
      });
    }

    function launchSideBySide(){
      const aw = window.screen.availWidth || window.innerWidth;
      const ah = window.screen.availHeight || window.innerHeight;

      const tW = 300, tH = 200, tL = 0, tT = 0;
      const sL = tW + 20, sT = 0;
      const sW = clamp(aw - sL, 640, aw);
      const sH = clamp(ah, 480, ah);

      const timerWin = window.open('', '', `width=${tW},height=${tH},left=${tL},top=${tT}`);
      const surveyWin = window.open(SURVEY_URL, 'survey',
        `width=${sW},height=${sH},left=${sL},top=${sT},resizable=yes,scrollbars=yes`);

      if (!timerWin || !surveyWin) {
        fallback.style.display = 'block';
        return;
      }
      timerWin.document.open();
      timerWin.document.write(timerHTML(TOTAL_MINUTES*60));
      timerWin.document.close();
    }

    function timerHTML(totalSeconds){
      return `
<!doctype html><meta charset="utf-8"><title>Timer</title>
<style>
  html,body{margin:0;padding:0;height:100%;width:100%;font-family:system-ui,Arial,sans-serif;background:#fff;}
  .wrap{display:flex;flex-direction:column;height:100%;}
  .banner{padding:6px 10px;font-size:12px;font-weight:700;background:#fff3cd;color:#7a5a00;border-bottom:1px solid #f0d98c;}
  .center{flex:1;display:flex;align-items:center;justify-content:center;}
  #t{font-size:48px;font-weight:800;font-variant-numeric:tabular-nums;}
  .warn{color:#b33;}
  .footer{padding:6px 10px;font-size:11px;color:#555;border-top:1px solid #eee;}
</style>
<div class="wrap">
  <div class="banner">⚠️ Keep this timer visible for the entire exam. Do not close this window.</div>
  <div class="center"><div id="t">--:--</div></div>
  <div class="footer" id="status">Timer running…</div>
</div>
<script>
  function fmt(s){s=Math.max(0,s|0);var m=Math.floor(s/60),x=s%60;return m+':'+String(x).padStart(2,'0')}
  var total=${totalSeconds|0}, end=Date.now()+total*1000, t=document.getElementById('t'), WARN=60;
  var baseTitle='Timer', flash=false, flashId=null;
  document.title=baseTitle+' ('+fmt(total)+')';

  function beep(){
    try{
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator(); osc.type='sine'; osc.frequency.value=880;
      const g=ctx.createGain(); g.gain.setValueAtTime(0.1,ctx.currentTime);
      osc.connect(g); g.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime+0.2);
    }catch(e){}
  }

  function tick(){
    var rem=Math.ceil((end-Date.now())/1000);
    if(rem<=0){
      rem=0; clearInterval(h);
      document.title='Time is up'; document.getElementById('status').textContent='Time is up.';
      window.close(); // auto-close at 0
    }
    t.textContent=fmt(rem);
    if(rem<=WARN){ t.classList.add('warn'); beep(); }
    if(!flash) document.title=baseTitle+' ('+fmt(rem)+')';
  }
  var h=setInterval(tick,1000); tick();

  window.addEventListener('beforeunload',function(e){
    e.preventDefault(); e.returnValue='Closing this timer will end your countdown!';
  });
  function startFlash(){
    if(flashId) return;
    flash=true;
    var on=true;
    flashId=setInterval(function(){
      document.title=on?'⏰ RETURN TO TIMER':baseTitle;
      on=!on;
    },800);
    document.getElementById('status').textContent='Timer running (background)…';
  }
  function stopFlash(){
    if(flashId){clearInterval(flashId);flashId=null;}
    flash=false;
    document.getElementById('status').textContent='Timer running…';
  }
  window.addEventListener('blur',startFlash);
  window.addEventListener('focus',stopFlash);
<\/script>`;
    }
  </script>
</body>
</html>


